name: Antigravity-Core Validation

on:
  push:
    branches: [main]
    paths: ['.agent/**']
  pull_request:
    branches: [main]
    paths: ['.agent/**']

jobs:
  validate-integrity:
    name: System Integrity Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ============================================
      # 1. Critical Files
      # ============================================
      - name: Check critical files exist
        run: |
          echo "üîç Checking critical files..."
          files=(
            ".agent/GEMINI.md"
            ".agent/ARCHITECTURE.md"
            ".agent/CHANGELOG.md"
            ".agent/VERSION"
            ".agent/project.json"
            ".agent/roles/AGENT_ROLES.md"
            ".agent/rules/STANDARDS.md"
            ".agent/rules/RULES-INDEX.md"
            ".agent/agents/CAPABILITY-MATRIX.md"
            ".agent/skills/DEPENDENCY-GRAPH.md"
          )
          missing=0
          for f in "${files[@]}"; do
            if [ -f "$f" ]; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå MISSING: $f"
              missing=$((missing + 1))
            fi
          done
          if [ $missing -gt 0 ]; then
            echo "::error::$missing critical file(s) missing!"
            exit 1
          fi
          echo "‚úÖ All critical files present."

      # ============================================
      # 2. Version Consistency (ALL 5 files)
      # ============================================
      - name: Version consistency check
        run: |
          echo "üîç Checking version consistency across all files..."
          VERSION=$(cat .agent/VERSION | tr -d '[:space:]')
          errors=0

          echo "  VERSION file: $VERSION"

          # project.json
          PJ_VER=$(python3 -c "import json; print(json.load(open('.agent/project.json'))['version'])")
          if [ "$VERSION" != "$PJ_VER" ]; then
            echo "  ‚ùå project.json: $PJ_VER (expected $VERSION)"
            errors=$((errors + 1))
          else
            echo "  ‚úÖ project.json: $PJ_VER"
          fi

          # GEMINI.md
          if grep -q "Version $VERSION" .agent/GEMINI.md; then
            echo "  ‚úÖ GEMINI.md"
          else
            echo "  ‚ùå GEMINI.md: version mismatch"
            errors=$((errors + 1))
          fi

          # ARCHITECTURE.md
          if grep -q "$VERSION" .agent/ARCHITECTURE.md; then
            echo "  ‚úÖ ARCHITECTURE.md"
          else
            echo "  ‚ùå ARCHITECTURE.md: version mismatch"
            errors=$((errors + 1))
          fi

          # RULES-INDEX.md
          if grep -q "$VERSION" .agent/rules/RULES-INDEX.md; then
            echo "  ‚úÖ RULES-INDEX.md"
          else
            echo "  ‚ùå RULES-INDEX.md: version mismatch"
            errors=$((errors + 1))
          fi

          if [ $errors -gt 0 ]; then
            echo ""
            echo "::error::Version mismatch in $errors file(s)! Run: pwsh .agent/scripts/bump-version.ps1 -Version $VERSION"
            exit 1
          fi
          echo "‚úÖ All versions consistent: $VERSION"

      # ============================================
      # 3. Agent Count Match
      # ============================================
      - name: Agent count validation
        run: |
          echo "üîç Checking agent count..."
          ACTUAL=$(find .agent/agents -name "*.md" ! -name "CAPABILITY-MATRIX.md" | wc -l | tr -d ' ')
          JSON_COUNT=$(python3 -c "import json; print(json.load(open('.agent/project.json'))['agents']['total'])")
          JSON_LIST=$(python3 -c "import json; print(len(json.load(open('.agent/project.json'))['agents']['list']))")

          echo "  Agent files: $ACTUAL"
          echo "  project.json total: $JSON_COUNT"
          echo "  project.json list: $JSON_LIST"

          if [ "$ACTUAL" != "$JSON_COUNT" ]; then
            echo "::error::Agent count mismatch: files=$ACTUAL, project.json.total=$JSON_COUNT"
            exit 1
          fi
          if [ "$ACTUAL" != "$JSON_LIST" ]; then
            echo "::error::Agent list mismatch: files=$ACTUAL, project.json.list=$JSON_LIST"
            exit 1
          fi
          echo "‚úÖ Agent count verified: $ACTUAL"

      # ============================================
      # 4. Dead Skill References
      # ============================================
      - name: Check for dead skill references
        run: |
          echo "üîç Checking for dead skill references in agents..."
          errors=0
          for agent in .agent/agents/*.md; do
            [[ "$(basename $agent)" == "CAPABILITY-MATRIX.md" ]] && continue
            while IFS= read -r ref; do
              skill=$(echo "$ref" | sed 's/.*@\[skills\///' | sed 's/\].*//')
              if [ -n "$skill" ] && [ ! -d ".agent/skills/$skill" ]; then
                echo "  ‚ùå $(basename $agent): dead ref ‚Üí $skill"
                errors=$((errors + 1))
              fi
            done < <(grep -o '@\[skills/[^]]*\]' "$agent" 2>/dev/null || true)
          done
          if [ $errors -gt 0 ]; then
            echo "::error::$errors dead skill reference(s) found!"
            exit 1
          fi
          echo "‚úÖ Zero dead skill references"

      # ============================================
      # 5. Skills have SKILL.md
      # ============================================
      - name: Validate skill completeness
        run: |
          echo "üîç Checking all skills have SKILL.md..."
          errors=0
          for d in .agent/skills/*/; do
            if [ ! -f "${d}SKILL.md" ]; then
              echo "  ‚ùå Missing SKILL.md: $d"
              errors=$((errors + 1))
            fi
          done
          if [ $errors -gt 0 ]; then
            echo "::error::$errors skill(s) missing SKILL.md!"
            exit 1
          fi
          SKILL_COUNT=$(find .agent/skills -maxdepth 1 -type d | tail -n +2 | wc -l | tr -d ' ')
          echo "‚úÖ All $SKILL_COUNT skills have SKILL.md"

      # ============================================
      # 6. Workflow Frontmatter
      # ============================================
      - name: Validate workflow frontmatter
        run: |
          echo "üîç Checking workflow frontmatter..."
          errors=0
          for wf in .agent/workflows/*.md; do
            if ! head -1 "$wf" | grep -q '^---$'; then
              echo "  ‚ùå No frontmatter: $(basename $wf)"
              errors=$((errors + 1))
            fi
          done
          if [ $errors -gt 0 ]; then
            echo "::error::$errors workflow(s) missing frontmatter!"
            exit 1
          fi
          WF_COUNT=$(find .agent/workflows -name "*.md" | wc -l | tr -d ' ')
          echo "‚úÖ All $WF_COUNT workflows have frontmatter"

      # ============================================
      # 7. JSON/YAML Validity
      # ============================================
      - name: Validate JSON files
        run: |
          echo "üîç Validating JSON files..."
          for f in $(find .agent -name "*.json" -type f); do
            if python3 -m json.tool "$f" > /dev/null 2>&1; then
              echo "  ‚úÖ $f"
            else
              echo "  ‚ùå Invalid JSON: $f"
              exit 1
            fi
          done
          echo "‚úÖ All JSON valid."

      - name: Validate YAML files
        run: |
          pip install pyyaml -q 2>/dev/null
          echo "üîç Validating YAML files..."
          python3 -c "
          import yaml, sys, os
          errors = 0
          for root, dirs, files in os.walk('.agent'):
              for f in files:
                  if f.endswith(('.yaml', '.yml')):
                      path = os.path.join(root, f)
                      try:
                          with open(path) as fh:
                              yaml.safe_load(fh)
                          print(f'  ‚úÖ {path}')
                      except Exception as e:
                          print(f'  ‚ùå {path}: {e}')
                          errors += 1
          if errors:
              sys.exit(1)
          print('‚úÖ All YAML valid.')
          "

  # ============================================
  # Component Census (informational)
  # ============================================
  census:
    name: System Census
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Component census
        run: |
          echo "üìä Antigravity-Core System Census"
          echo "========================================"
          echo ""
          echo "Version:    $(cat .agent/VERSION)"
          echo ""
          echo "Agents:     $(find .agent/agents -name '*.md' ! -name 'CAPABILITY-MATRIX.md' | wc -l | tr -d ' ')"
          echo "Skills:     $(find .agent/skills -maxdepth 1 -type d | tail -n +2 | wc -l | tr -d ' ')"
          echo "Workflows:  $(find .agent/workflows -name '*.md' | wc -l | tr -d ' ')"
          echo "Rules:      $(find .agent/rules -name '*.md' -type f ! -name 'RULES-INDEX.md' ! -name 'STANDARDS.md' ! -name 'universal-code-standards.md' ! -name 'velzon-admin.md' ! -name 'README.md' ! -name '_index.md' | wc -l | tr -d ' ')"
          echo "Scripts:    $(find .agent/scripts -type f | wc -l | tr -d ' ') ($(find .agent/scripts -name '*.ps1' | wc -l | tr -d ' ') ps1 + $(find .agent/scripts -name '*.sh' | wc -l | tr -d ' ') sh + other)"
          echo "Memory:     $(find .agent/memory -name '*.yaml' 2>/dev/null | wc -l | tr -d ' ') YAML files"
          echo ""
          echo "Total size: $(du -sh .agent | cut -f1)"
          echo "========================================"
