# Secret Scanning Configuration
# Detect and prevent credential leaks in code
# Industry standard: GitHub, GitLab, Snyk

version: 1.0
created: 2026-01-19

# ============================================================
# SETTINGS
# ============================================================
settings:
  enabled: true
  mode: block  # block|warn|report
  scan_on:
    - pre_commit
    - pre_push
    - pr_creation
  
  # Action when secret detected
  on_detection:
    block_commit: true
    notify_developer: true
    log_incident: true

# ============================================================
# SECRET PATTERNS
# ============================================================
patterns:
  # Cloud Provider Keys
  aws:
    - name: AWS Access Key ID
      pattern: "AKIA[0-9A-Z]{16}"
      severity: critical
      
    - name: AWS Secret Access Key
      pattern: "[0-9a-zA-Z/+]{40}"
      context_required: "aws|secret|key"
      severity: critical

  google_cloud:
    - name: GCP Service Account
      pattern: '"type"\\s*:\\s*"service_account"'
      severity: critical
      
    - name: GCP API Key
      pattern: "AIza[0-9A-Za-z_-]{35}"
      severity: critical

  azure:
    - name: Azure Connection String
      pattern: "DefaultEndpointsProtocol=https;AccountName=[^;]+"
      severity: critical

  # API Keys & Tokens
  api_keys:
    - name: Stripe Live Key
      pattern: "sk_live_[0-9a-zA-Z]{24,}"
      severity: critical
      
    - name: Stripe Test Key
      pattern: "sk_test_[0-9a-zA-Z]{24,}"
      severity: warning
      
    - name: GitHub Token
      pattern: "ghp_[0-9a-zA-Z]{36}"
      severity: critical
      
    - name: GitHub OAuth
      pattern: "gho_[0-9a-zA-Z]{36}"
      severity: critical
      
    - name: GitLab Token
      pattern: "glpat-[0-9a-zA-Z_-]{20}"
      severity: critical
      
    - name: Slack Token
      pattern: "xox[baprs]-[0-9a-zA-Z]{10,}"
      severity: critical
      
    - name: Twilio
      pattern: "SK[0-9a-fA-F]{32}"
      severity: critical
      
    - name: SendGrid
      pattern: "SG\\.[0-9A-Za-z_-]{22}\\.[0-9A-Za-z_-]{43}"
      severity: critical
      
    - name: Mailgun
      pattern: "key-[0-9a-zA-Z]{32}"
      severity: critical

  # Database Credentials
  database:
    - name: Database URL with Password
      pattern: "(mysql|postgres|mongodb)://[^:]+:[^@]+@"
      severity: critical
      
    - name: Database Password
      pattern: 'DB_PASSWORD\\s*=\\s*["\']?[^"\'\\s]+["\']?'
      severity: critical
      exclude_if: ".env.example"

  # Private Keys
  private_keys:
    - name: RSA Private Key
      pattern: "-----BEGIN RSA PRIVATE KEY-----"
      severity: critical
      
    - name: SSH Private Key
      pattern: "-----BEGIN OPENSSH PRIVATE KEY-----"
      severity: critical
      
    - name: PGP Private Key
      pattern: "-----BEGIN PGP PRIVATE KEY BLOCK-----"
      severity: critical

  # JWT & Auth
  auth:
    - name: JWT Token
      pattern: "eyJ[A-Za-z0-9_-]*\\.eyJ[A-Za-z0-9_-]*\\.[A-Za-z0-9_-]*"
      severity: warning
      
    - name: Bearer Token
      pattern: "Bearer [A-Za-z0-9_-]{20,}"
      severity: warning
      
    - name: Basic Auth
      pattern: "Basic [A-Za-z0-9+/=]{20,}"
      severity: warning

  # Generic Patterns
  generic:
    - name: Password Assignment
      pattern: "(password|passwd|pwd)\\s*[=:]\\s*['\"][^'\"]{8,}['\"]"
      severity: high
      case_insensitive: true
      
    - name: Secret Assignment
      pattern: "(secret|api_key|apikey|access_token)\\s*[=:]\\s*['\"][^'\"]+['\"]"
      severity: high
      case_insensitive: true
      
    - name: Hardcoded Credential
      pattern: "(credential|auth_token|private_key)\\s*[=:]\\s*['\"][^'\"]+['\"]"
      severity: high
      case_insensitive: true

# ============================================================
# EXCLUSIONS
# ============================================================
exclusions:
  # Files to skip
  files:
    - "*.md"
    - "*.txt"
    - "CHANGELOG*"
    - "LICENSE*"
    - ".env.example"
    - "*.test.*"
    - "*.spec.*"
    
  # Directories to skip
  directories:
    - "node_modules"
    - "vendor"
    - ".git"
    - "dist"
    - "build"
    - "coverage"
    
  # Allow test/example patterns
  allow_patterns:
    - "test_"
    - "example_"
    - "sample_"
    - "demo_"
    - "fake_"
    - "mock_"
    - "placeholder"
    - "your_api_key_here"

# ============================================================
# ACTIONS
# ============================================================
actions:
  # When critical secret found
  on_critical:
    - block_action: true
    - message: |
        ðŸ”´ CRITICAL: Secret detected!
        
        File: {file}
        Line: {line}
        Type: {pattern_name}
        
        This commit has been BLOCKED.
        
        To fix:
        1. Remove the secret from code
        2. Use environment variables instead
        3. Add to .env (never commit .env!)
        
        Example fix:
        Before: $apiKey = "sk_live_123abc..."
        After:  $apiKey = env('STRIPE_SECRET_KEY')
    
  # When high severity found
  on_high:
    - block_action: true
    - message: |
        ðŸŸ  HIGH: Potential credential detected!
        
        File: {file}
        Line: {line}
        Type: {pattern_name}
        
        Please review and confirm this is not a real secret.
        
        If this is a false positive, add to .secretscanignore
        
  # When warning found
  on_warning:
    - block_action: false
    - message: |
        ðŸŸ¡ WARNING: Possible secret pattern detected
        
        File: {file}
        Line: {line}
        Type: {pattern_name}
        
        Please verify this is not sensitive data.

# ============================================================
# INTEGRATION
# ============================================================
integration:
  # Git hooks
  git_hooks:
    pre_commit:
      enabled: true
      command: ".agent/scripts/secret-scan.ps1 --staged"
      
    pre_push:
      enabled: true
      command: ".agent/scripts/secret-scan.ps1 --all"
  
  # CI/CD
  ci_cd:
    enabled: true
    fail_on: [critical, high]
    warn_on: [warning]
    
  # Reporting
  reporting:
    log_file: ".agent/memory/secret-scan-log.json"
    report_to: ai-code-reviewer

# ============================================================
# REMEDIATION GUIDE
# ============================================================
remediation:
  steps:
    - title: "Remove from code"
      description: "Delete the hardcoded secret from your code"
      
    - title: "Use environment variables"
      description: "Store secret in .env file"
      example: |
        # .env (never commit!)
        STRIPE_SECRET_KEY=sk_live_...
        
        # Code
        $key = env('STRIPE_SECRET_KEY');
        
    - title: "Rotate the secret"
      description: "Generate new secret in service dashboard"
      note: "Old secret may be compromised if committed"
      
    - title: "Scan git history"
      description: "Use git filter-branch or BFG to remove from history"
      command: "bfg --replace-text secrets.txt"

# ============================================================
# FALSE POSITIVE HANDLING
# ============================================================
false_positives:
  # File to list allowed patterns
  ignore_file: ".secretscanignore"
  
  # Format
  format: |
    # .secretscanignore
    # One pattern per line
    # Supports file:line format
    
    # Example:
    # config/services.php:23
    # tests/**/*.php
    # docs/examples/*
